<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HSK 1 — Study App (online-only)</title>
<meta name="theme-color" content="#0b0f14">
<style>
:root{
  --bg:#0b0f14;--panel:#101722;--muted:#7d8ba3;--text:#e5ecfa;
  --accent:#5bbcff;--accent-2:#a6e36a;--danger:#ff7b7b;--ok:#62d2a2;
  --border:#1e2a3a;--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans SC",sans-serif
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:var(--font)}
#app{max-width:1100px;margin:0 auto;padding:12px 12px 48px}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:10px;position:sticky;top:0;background:var(--bg);z-index:5}
.logo{font-weight:800;letter-spacing:.5px;color:var(--accent)}
.tabs{display:flex;gap:6px;flex-wrap:wrap}
.tab{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
.tab.active{border-color:var(--accent);color:var(--accent)}
.panel{display:none;padding:12px;background:var(--panel);border:1px solid var(--border);border-radius:12px}
.panel.active{display:block}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.card{background:#0e1622;border:1px solid var(--border);border-radius:12px;padding:12px}
.card-title{color:var(--muted);font-weight:600;margin-bottom:8px}
.card-body{display:grid;gap:10px}
.primary,.ghost{padding:10px 14px;border-radius:10px;border:1px solid var(--border);cursor:pointer}
.primary{background:var(--accent);color:#00121f;border-color:transparent;font-weight:700}
.ghost{background:transparent;color:var(--text)}
.primary:disabled,.ghost:disabled{opacity:.6;cursor:not-allowed}
.flashcard{background:#0e1622;border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center;user-select:none}
.card-side.hidden{display:none}
.hanzi{font-size:64px;line-height:1.2;margin:6px 0 2px}
.pinyin-front{font-size:20px;color:var(--accent-2);margin-top:6px}
.hint{color:var(--muted);font-size:13px}
.pinyin{font-size:22px;color:var(--accent-2);margin-top:6px}
.english{font-size:18px}
.example{margin-top:8px;font-size:16px;color:#cfe4ff}
.audio-row{display:flex;gap:8px;justify-content:center;margin-top:10px}
.srs-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
.srs-btn{padding:10px;border-radius:10px;border:1px solid var(--border);cursor:pointer}
.again{background:#201018;color:#ffb2b2;border-color:#3a2026}
.hard{background:#182018;color:#e4ffb2;border-color:#263a20}
.good{background:#121c24;color:#bfe7ff;border-color:#243748}
.easy{background:#0f1b13;color:#b9ffd8;border-color:#204430}
.queue-info{color:var(--muted);margin-top:8px}
.quiz-controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.quiz-card{background:#0e1622;border:1px solid var(--border);border-radius:12px;padding:12px}
.quiz-q{font-size:26px;margin-bottom:6px}
.quiz-sub{font-size:16px;color:var(--muted);margin-bottom:10px}
.quiz-options{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
.quiz-opt{padding:10px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#101a28}
.quiz-opt.correct{border-color:var(--ok)}
.quiz-opt.wrong{border-color:var(--danger)}
.recap{margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:10px}
label{display:grid;gap:6px;color:var(--muted)}
input[type="number"],select{background:#0e1622;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px}
footer{margin-top:14px;display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
.muted{color:var(--muted)}
@media (max-width:600px){.hanzi{font-size:48px}.pinyin{font-size:20px}}
</style>
</head>
<body>
<div id="app">
  <header class="topbar">
    <div class="logo">HSK 1 · 500 — v1.4 (online)</div>
    <nav class="tabs">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="study">Study</button>
      <button class="tab" data-tab="quiz">Quizzes</button>
      <button class="tab" data-tab="progress">Progress</button>
      <button class="tab" data-tab="settings">Settings</button>
      <button class="tab" data-tab="importexport">Import/Export</button>
    </nav>
  </header>

  <main>
    <section id="dashboard" class="panel active">
      <h1>New HSK 3.0 Band 1 — 500 words. Online-only.</h1>
      <div id="net-status" class="muted">Loading dataset…</div>
      <div class="cards">
        <div class="card">
          <div class="card-title">Today</div>
          <div class="card-body">
            <div id="today-stats"></div>
            <button id="start-15" class="primary" disabled>Start · 15 new</button>
            <button id="start-reviews" class="ghost" disabled>Review due</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Progress</div>
          <div class="card-body">
            <div id="streak">Streak: 0</div>
            <div id="xp">XP: 0 · Level 1</div>
            <div id="badges" class="badges"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="study" class="panel">
      <div class="study-wrap">
        <div id="card-area" class="flashcard">
          <div id="card-front" class="card-side">
            <div id="hanzi" class="hanzi">你好</div>
            <div id="pinyin-front" class="pinyin-front">nǐ hǎo</div>
            <div class="hint">Tap to reveal meaning</div>
          </div>
          <div id="card-back" class="card-side hidden">
            <div id="pinyin" class="pinyin">nǐ hǎo</div>
            <div id="english" class="english">hello</div>
            <div id="example" class="example">你好！</div>
            <div class="audio-row">
              <button id="speak-word">Play word</button>
              <button id="speak-sent">Play sentence</button>
              <select id="rate">
                <option value="0.5">0.5×</option>
                <option value="1" selected>1×</option>
                <option value="1.5">1.5×</option>
              </select>
            </div>
          </div>
        </div>

        <div class="srs-row">
          <button class="srs-btn again" data-grade="0">Again</button>
          <button class="srs-btn hard" data-grade="3">Hard</button>
          <button class="srs-btn good" data-grade="4">Good</button>
          <button class="srs-btn easy" data-grade="5">Easy</button>
        </div>

        <div class="queue-info" id="queue-info">Queue — New: 0 · Review: 0</div>
      </div>
    </section>

    <section id="quiz" class="panel">
      <h2>Quizzes</h2>
      <div class="quiz-controls">
        <button data-quiz="mcq" class="primary">Multiple Choice</button>
        <button data-quiz="listening" class="ghost">Listening</button>
        <button data-quiz="matching" class="ghost">Matching</button>
        <button data-quiz="cloze" class="ghost">Cloze (missing word)</button>
      </div>
      <div id="quiz-area"></div>
      <div id="quiz-recap" class="recap hidden"></div>
    </section>

    <section id="progress" class="panel">
      <h2>Progress</h2>
      <div id="progress-stats"></div>
      <div class="tags">
        <h3>By Tag</h3>
        <div id="tag-progress"></div>
      </div>
    </section>

    <section id="settings" class="panel">
      <h2>Settings</h2>
      <div class="settings-grid">
        <label>New cards / day
          <input id="new-per-day" type="number" min="1" max="100" value="15" />
        </label>
        <label>Max reviews / day
          <input id="max-reviews" type="number" min="20" max="999" value="999" />
        </label>
        <label>Show pinyin on front
          <input id="show-pinyin" type="checkbox" checked />
        </label>
        <label>Dark theme
          <input id="dark-theme" type="checkbox" checked />
        </label>
      </div>
      <p class="muted">Data stays in your browser. Requires internet to load the list.</p>
    </section>

    <section id="importexport" class="panel">
      <h2>Import / Export</h2>
      <div class="import-export">
        <button id="export-csv" class="ghost">Export progress CSV</button>
        <input type="file" id="import-csv" accept=".csv" />
        <label for="import-csv" class="primary">Import CSV</label>
      </div>
      <p class="muted">Format: simplified,pinyin,english,pos,tag</p>
    </section>
  </main>

  <footer>
    <div>Built for you · v1.4 (online)</div>
  </footer>
</div>

<script>
// ===== Config
const RAW_DATA_URL = "https://raw.githubusercontent.com/drkameleon/complete-hsk-vocabulary/main/wordlists/inclusive/new/1.min.json";
const LS_KEYS = {
  settings: "hsk1_settings",
  progress: "hsk1_progress_v14",
  streak: "hsk1_streak",
  xp: "hsk1_xp",
  badges: "hsk1_badges"
};

// ===== Settings + theme
const settings = loadSettings() || { newPerDay:15, maxReviews:999, showPinyin:true, darkTheme:true };
applyTheme(settings.darkTheme);

// ===== State
let WORDS = [];
let QUEUE = { new:[], review:[] };
let currentCard = null;
let flipped = false;

// ===== Init
(async function init(){
  bindUI();
  await cleanupOldCaches();
  await loadDatasetOnline();
  rebuildTodayQueue();
  updateDashboard();
  enableStartButtons();
  renderTagProgress();
})();

async function cleanupOldCaches(){
  try{
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
    }
    if (window.caches && caches.keys) {
      const keys = await caches.keys();
      for (const k of keys) if (k.startsWith("hsk1-")) await caches.delete(k);
    }
  }catch(_){}
}

async function loadDatasetOnline(){
  const status = document.getElementById("net-status");
  try{
    status.textContent = "Loading dataset from the internet…";
    const res = await fetch(RAW_DATA_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();
    WORDS = data.map((e,idx)=>normalizeEntry(e,idx));
    status.textContent = `Loaded ${WORDS.length} words.`;
  }catch(e){
    console.error(e);
    status.textContent = "Could not load the list. Check your internet and reload.";
  }
}

function normalizeEntry(entry, idx){
  const form = (entry.f && entry.f[0]) || {};
  const pinyin = (form.i && form.i.y) || (entry.i && entry.i.y) || entry.y || "";
  const english = Array.isArray(form.m) ? form.m[0] : (entry.english || "");
  const pos = entry.p || [];
  const tag = deriveTag({ p: pos, s: entry.s });
  return {
    id: entry.s + "#" + idx,
    hanzi: entry.s,
    pinyin,
    english,
    pos,
    tag,
    example: makeExample(entry.s, pinyin, pos[0] || "n"),
  };
}

function deriveTag(e){
  const p = (e.p && e.p[0]) || "";
  if (p==="q") return "measure word";
  if (p==="m") return "number";
  if (p==="r") return "pronoun";
  if (p==="v") return "verb";
  if (["a","ad","an","ag"].includes(p)) return "adjective";
  if (p==="t") return "time";
  return "general";
}

function makeExample(hz, py, pos){
  const t = {
    v:[`我${hz}。`,`他在${hz}。`,`我们现在${hz}。`],
    a:[`这个很${hz}。`,`今天的天气很${hz}。`],
    r:[`${hz}在这儿。`,`${hz}喜欢汉语。`],
    m:[`我有三${hz}书。`,`请给我一${hz}水。`],
    q:[`一${hz}人。`,`三${hz}苹果。`],
    t:[`我们${hz}见。`,`他${hz}来。`],
    default:[`这是${hz}。`,`我喜欢${hz}。`]
  };
  const arr = t[pos] || t.default;
  return arr[Math.floor(Math.random()*arr.length)];
}

// ===== UI helpers
function $(s){ return document.querySelector(s) }
function $all(s){ return Array.from(document.querySelectorAll(s)) }

function bindUI(){
  $all(".tab").forEach(b=>b.addEventListener("click",()=>switchTab(b.dataset.tab)));
  $("#card-area").addEventListener("click", ()=>{
    flipped = !flipped;
    $("#card-front").classList.toggle("hidden", flipped);
    $("#card-back").classList.toggle("hidden", !flipped);
  });
  $all(".srs-btn").forEach(b=>b.addEventListener("click",()=>grade(b.dataset.grade)));
  $("#start-15").addEventListener("click", ()=>{ settings.newPerDay=parseInt($("#new-per-day").value||"15",10); rebuildTodayQueue(true); switchTab("study"); nextCard(); });
  $("#start-reviews").addEventListener("click", ()=>{ rebuildTodayQueue(false); switchTab("study"); nextCard(); });
  $("#speak-word").addEventListener("click",()=>speak(currentCard?.hanzi, parseFloat($("#rate").value)));
  $("#speak-sent").addEventListener("click",()=>speak(currentCard?.example, parseFloat($("#rate").value)));

  // settings
  $("#new-per-day").value = settings.newPerDay;
  $("#max-reviews").value = settings.maxReviews;
  $("#show-pinyin").checked = settings.showPinyin;
  $("#dark-theme").checked = settings.darkTheme;
  $("#new-per-day").addEventListener("input",e=>saveSettings({newPerDay:parseInt(e.target.value,10)}));
  $("#max-reviews").addEventListener("input",e=>saveSettings({maxReviews:parseInt(e.target.value,10)}));
  $("#show-pinyin").addEventListener("change",e=>saveSettings({showPinyin:e.target.checked}));
  $("#dark-theme").addEventListener("change",e=>{ saveSettings({darkTheme:e.target.checked}); applyTheme(e.target.checked); });

  // quizzes
  $all("[data-quiz]").forEach(b=>b.addEventListener("click",()=>startQuiz(b.dataset.quiz)));

  // import/export
  $("#export-csv").addEventListener("click", exportCSV);
  $("#import-csv").addEventListener("change", importCSV);
}

function enableStartButtons(){
  $("#start-15").disabled = false;
  $("#start-reviews").disabled = false;
  $("#net-status").textContent = "Dataset loaded. You’re ready.";
}

function switchTab(name){
  $all(".panel").forEach(p=>p.classList.remove("active"));
  $all(".tab").forEach(t=>t.classList.remove("active"));
  document.getElementById(name).classList.add("active");
  document.querySelector(`.tab[data-tab='${name}']`).classList.add("active");
}

function applyTheme(dark){
  document.documentElement.style.setProperty("--bg", dark ? "#0b0f14" : "#f4f8ff");
  document.documentElement.style.setProperty("--panel", dark ? "#101722" : "#fff");
  document.documentElement.style.setProperty("--text", dark ? "#e5ecfa" : "#0b0f14");
}

// ===== Dashboard/progress
function updateDashboard(){
  const prog = loadProgress();
  const due = Object.values(prog).filter(p=>new Date(p.due)<=today()).length;
  const learned = Object.keys(prog).length;
  $("#today-stats").textContent = `Learned: ${learned} · Due today: ${due}`;
  $("#streak").textContent = `Streak: ${getStreak()}`;
  $("#xp").textContent = `XP: ${getXP()} · Level ${levelFromXP(getXP())}`;
  renderBadges();
}

function renderTagProgress(){
  const prog = loadProgress(), counts = {};
  for (const w of WORDS) {
    counts[w.tag] = counts[w.tag] || { learned:0, total:0 };
    counts[w.tag].total++;
    if (prog[w.id]) counts[w.tag].learned++;
  }
  const dom = document.getElementById("tag-progress");
  dom.innerHTML = Object.entries(counts).map(([tag,c])=>{
    const pct = Math.round((c.learned/c.total)*100);
    return `<div>${tag}: ${c.learned}/${c.total} (${pct}%)</div>`;
  }).join("");
}

// ===== Queue & study
function rebuildTodayQueue(includeNew=true){
  const prog = loadProgress();
  const due = WORDS.filter(w=>{ const p=prog[w.id]; return p && new Date(p.due)<=today(); });
  let newOnes = [];
  if (includeNew) {
    const unseen = WORDS.filter(w=>!prog[w.id]);
    newOnes = shuffle(unseen).slice(0, settings.newPerDay);
  }
  QUEUE.review = shuffle(due).slice(0, settings.maxReviews);
  QUEUE.new = newOnes;
  $("#queue-info").textContent = `Queue — New: ${QUEUE.new.length} · Review: ${QUEUE.review.length}`;
}

function nextCard(){
  if (QUEUE.review.length) currentCard = QUEUE.review.shift();
  else if (QUEUE.new.length) currentCard = QUEUE.new.shift();
  else { alert("All done for now."); updateDashboard(); return; }

  flipped = false;
  $("#card-front").classList.remove("hidden");
  $("#card-back").classList.add("hidden");
  $("#hanzi").textContent = currentCard.hanzi;
  $("#pinyin-front").textContent = settings.showPinyin ? currentCard.pinyin : "";
  $("#pinyin").textContent = currentCard.pinyin;
  $("#english").textContent = currentCard.english;
  $("#example").textContent = currentCard.example;
  $("#queue-info").textContent = `Queue — New: ${QUEUE.new.length} · Review: ${QUEUE.review.length}`;
}

function grade(val){
  if (!currentCard) return;
  const prog = loadProgress();
  const now = today();
  const rec = prog[currentCard.id] || { reps:0, interval:0, EF:2.5, due:now, lapses:0 };
  const g = parseInt(val,10);

  if (g < 3) {
    rec.reps = 0; rec.interval = 1; rec.due = addDays(now,1); rec.lapses = (rec.lapses||0)+1; addXP(5);
  } else {
    rec.reps += 1;
    if (rec.reps === 1) rec.interval = 1;
    else if (rec.reps === 2) rec.interval = 6;
    else rec.interval = Math.round(rec.interval * rec.EF);
    rec.EF = Math.max(1.3, rec.EF + (0.1 - (5 - g) * (0.08 + (5 - g) * 0.02)));
    rec.due = addDays(now, rec.interval);
    addXP(10 + g);
  }
  prog[currentCard.id] = rec;
  saveProgress(prog);
  nextCard();
}

// ===== Quizzes
function startQuiz(type){
  const area = $("#quiz-area");
  area.innerHTML = "";
  $("#quiz-recap").classList.add("hidden");
  const pool = shuffle(WORDS).slice(0,10);
  if (type==="mcq") runMCQ(pool);
  if (type==="listening") runListening(pool);
  if (type==="matching") runMatching(pool);
  if (type==="cloze") runCloze(pool);
}

function runMCQ(pool){
  const area = $("#quiz-area");
  let i=0, correct=0, mistakes=[];
  function render(){
    if (i>=pool.length) return finish();
    const w = pool[i];
    area.innerHTML = `<div class="quiz-card">
      <div class="quiz-q">${w.hanzi}</div>
      <div class="quiz-sub">${w.pinyin}</div>
      <div class="quiz-options"></div>
    </div>`;
    const opts = shuffle([w,...randomOthers(w,3)]).map(o=>o.english);
    const box = area.querySelector(".quiz-options");
    opts.forEach(opt=>{
      const btn = document.createElement("button");
      btn.className="quiz-opt"; btn.textContent=opt;
      btn.onclick=()=>{
        if (opt===w.english){ btn.classList.add("correct"); correct++; }
        else { btn.classList.add("wrong"); mistakes.push(w); }
        setTimeout(()=>{ i++; render(); }, 350);
      };
      box.appendChild(btn);
    });
  }
  function finish(){ recap(correct, pool.length, mistakes); }
  render();
}

function runListening(pool){
  const area = $("#quiz-area");
  let i=0, correct=0, mistakes=[];
  function render(){
    if (i>=pool.length) return finish();
    const w = pool[i];
    area.innerHTML = `<div class="quiz-card">
      <button class="primary" id="play">Play</button>
      <div class="quiz-q">Type what you hear (hanzi or pinyin)</div>
      <input id="type-in" />
      <button id="submit" class="ghost">Check</button>
    </div>`;
    $("#play").onclick=()=>speak(w.hanzi,1);
    $("#submit").onclick=()=>{
      const val = $("#type-in").value.trim();
      const ok = val===w.hanzi || normalizePinyin(val)===normalizePinyin(w.pinyin);
      if (ok) correct++; else mistakes.push(w);
      i++; render();
    };
  }
  function finish(){ recap(correct, pool.length, mistakes); }
  render();
}

function runMatching(pool){
  const area = $("#quiz-area");
  const items = shuffle(pool).slice(0,6);
  const left = items.map(w=>({id:w.id,label:`${w.hanzi} — ${w.pinyin}`,w}));
  const right = shuffle(items.map(w=>({id:w.id,label:w.english})));

  area.innerHTML = `<div class="quiz-card">
    <div class="quiz-q">Match pairs</div>
    <div style="display:flex;gap:8px;">
      <div id="leftCol" style="flex:1;display:grid;gap:8px;"></div>
      <div id="rightCol" style="flex:1;display:grid;gap:8px;"></div>
    </div>
  </div>`;
  const leftCol=$("#leftCol"), rightCol=$("#rightCol");
  let selected=null, matched=0, mistakes=[];

  left.forEach(item=>{
    const b=document.createElement("button"); b.className="quiz-opt"; b.textContent=item.label;
    b.onclick=()=>{ if(b.disabled) return; selected={...item, btn:b}; };
    leftCol.appendChild(b);
  });
  right.forEach(item=>{
    const b=document.createElement("button"); b.className="quiz-opt"; b.textContent=item.label;
    b.onclick=()=>{
      if(b.disabled || !selected) return;
      if(item.id===selected.id){
        b.classList.add("correct"); selected.btn.classList.add("correct");
        b.disabled=true; selected.btn.disabled=true; matched++; selected=null;
        if(matched===items.length) recap(items.length, items.length, mistakes);
      }else{
        b.classList.add("wrong"); selected.btn.classList.add("wrong");
        mistakes.push(selected.w);
        setTimeout(()=>{ b.classList.remove("wrong"); selected.btn.classList.remove("wrong"); selected=null; },350);
      }
    };
    rightCol.appendChild(b);
  });
}

function runCloze(pool){
  const area=$("#quiz-area");
  let i=0, correct=0, mistakes=[];
  function render(){
    if(i>=pool.length) return finish();
    const w = pool[i];
    const sentence = w.example.replace(w.hanzi,"____");
    const options = shuffle([w,...randomOthers(w,3)]);
    area.innerHTML = `<div class="quiz-card">
      <div class="quiz-q">${sentence}</div>
      <div class="quiz-sub">Answer: ${w.hanzi} — ${w.pinyin}</div>
      <div class="quiz-options"></div>
    </div>`;
    const box = area.querySelector(".quiz-options");
    options.forEach(o=>{
      const btn=document.createElement("button");
      btn.className="quiz-opt"; btn.textContent=`${o.hanzi}`;
      btn.onclick=()=>{
        if(o.hanzi===w.hanzi){ btn.classList.add("correct"); correct++; }
        else { btn.classList.add("wrong"); mistakes.push(w); }
        setTimeout(()=>{ i++; render(); },350);
      };
      box.appendChild(btn);
    });
  }
  function finish(){ recap(correct, pool.length, mistakes); }
  render();
}

function recap(correct,total,mistakes){
  const box=$("#quiz-recap");
  box.classList.remove("hidden");
  box.innerHTML = `<strong>Score:</strong> ${correct}/${total}. Mistakes: ${mistakes && mistakes.length ? mistakes.map(w=>w.hanzi).join("、") : "None"}`;
}

// ===== Helpers & persistence
function randomOthers(exclude,n){ const pool=WORDS.filter(w=>w.hanzi!==exclude.hanzi); return shuffle(pool).slice(0,n) }
function normalizePinyin(p){ return (p||"").toLowerCase().replace(/\s+/g,"").normalize("NFD").replace(/[\u0300-\u036f]/g,"") }
function today(){ const d=new Date(); d.setHours(0,0,0,0); return d }
function addDays(date,n){ return new Date(date.getTime()+n*86400000) }
function shuffle(a){ return a.slice().sort(()=>Math.random()-0.5) }

function loadProgress(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.progress))||{} }catch{ return {} } }
function saveProgress(o){ localStorage.setItem(LS_KEYS.progress, JSON.stringify(o)) }

function loadSettings(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.settings)) }catch{ return null } }
function saveSettings(p){ const next={...(loadSettings()||settings),...p}; localStorage.setItem(LS_KEYS.settings, JSON.stringify(next)); Object.assign(settings,next) }

function getXP(){ return parseInt(localStorage.getItem(LS_KEYS.xp)||"0",10) }
function addXP(n){ localStorage.setItem(LS_KEYS.xp, String(getXP()+n)); updateDashboard() }
function levelFromXP(xp){ return Math.floor(Math.sqrt(xp/50))+1 }
function getStreak(){
  const key=LS_KEYS.streak, last=localStorage.getItem(key), todayStr=new Date().toDateString();
  if(last!==todayStr){ localStorage.setItem(key,todayStr); const n=parseInt(localStorage.getItem(key+"_count")||"0",10)+1; localStorage.setItem(key+"_count",String(n)); return n }
  return parseInt(localStorage.getItem(key+"_count")||"1",10)
}
function renderBadges(){
  const xp=getXP(); const arr=[];
  if(xp>=100) arr.push("Tone Trainee");
  if(xp>=300) arr.push("Tone Master");
  if(xp>=600) arr.push("HSK 1 Hero");
  document.getElementById("badges").innerHTML = arr.map(b=>`<span class="badge">${b}</span>`).join("") || "";
}

// speech
function speak(text, rate=1){
  if(!window.speechSynthesis){ alert("Speech synthesis not supported."); return; }
  const u = new SpeechSynthesisUtterance(text);
  u.lang="zh-CN"; u.rate=rate; speechSynthesis.speak(u);
}

// CSV
function exportCSV(){
  const prog = loadProgress();
  const rows=[["simplified","pinyin","english","pos","tag","reps","interval","due","EF","lapses"]];
  for(const w of WORDS){
    const p=prog[w.id]||{};
    rows.push([w.hanzi,w.pinyin,w.english,(w.pos||[]).join("/"),w.tag,p.reps||0,p.interval||0,p.due||"",p.EF||2.5,p.lapses||0]);
  }
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  downloadFile("hsk1_progress.csv","text/csv",csv);
}
function importCSV(evt){
  const f=evt.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    const lines=r.result.split(/\r?\n/).filter(Boolean); lines.shift();
    const prog=loadProgress();
    for(const line of lines){
      const cols=parseCSVLine(line);
      const [hanzi,pinyin,english,pos,tag,reps,interval,due,EF,lapses]=cols;
      const w=WORDS.find(x=>x.hanzi===hanzi && x.pinyin===pinyin);
      if(!w) continue;
      prog[w.id]={reps:parseInt(reps||"0",10),interval:parseInt(interval||"0",10),due:due||today(),EF:parseFloat(EF||"2.5"),lapses:parseInt(lapses||"0",10)};
    }
    saveProgress(prog); alert("Import complete."); updateDashboard();
  };
  r.readAsText(f);
}
function parseCSVLine(s){
  const out=[]; let i=0,cur="",inQ=false;
  while(i<s.length){ const ch=s[i++]; if(ch==='"'){ if(inQ && s[i]==='"'){cur+='"'; i++;} else inQ=!inQ; }
  else if(ch==="," && !inQ){ out.push(cur); cur=""; } else cur+=ch; }
  out.push(cur); return out;
}
function downloadFile(name,mime,content){
  const blob=new Blob([content],{type:mime});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click();
}
</script>
</body>
</html>
